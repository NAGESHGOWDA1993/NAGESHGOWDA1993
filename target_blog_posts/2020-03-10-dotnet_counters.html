<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Mr David Betteridge</title>
    <link rel="stylesheet" type="text/css" href="/index.css">
</head>

<body>
    <div class="container">
        <div class="item-header_logo">
            <a href="/index.html"><img src="/images/david_betteridge.png" alt="Mr David Betteridge"
                    class="top_left_logo"></a>
        </div>
        <div class="item-header_text">
            <span>David Betteridge</span>

            <div class="filler"></div>

            <div class="theme-switch-wrapper">
                <em>Theme</em>

                <select name="theme-selector" id="theme-selector">
                    <option value="blue">Blue</option>
                    <option value="dark">Dark</option>
                    <option value="light">Light</option>
                </select>
            </div>
        </div>



        <div class="item-sidebar">
            <ul>
                <li><a href="/target_files/about.html">About me</a></li>
                <li><a href="/target_files/running.html">My running</a></li>
                <li><a href="/target_files/london_to_paris.html">London to Paris</a></li>
                <li><a href="/familybikerides/index.html">Family bike rides</a></li>
                <li><a href="/target_files/blogs.html">My blog</a></li>
                <li><a href="https://www.meetup.com/York-Code-Dojo/">York Code Dojo</a></li>
                <li><a href="https://yorkdevelopers.org">York Developers</a></li>
                <li><a href="https://github.com/DavidBetteridge">My github account</a></li>
                <li><a href="/resources">Some useful resources</a></li>
            </ul>
        </div>
        <div class="item-content">
            <div class="content-container">
                <h2>dotnet-counters</h2>
<p>.NET Core 3.0 and above has built in support for monitoring performance counters generated by your application.</p>
<h3>Getting started</h3>
<p>Install as a global dotnet tool using <code>dotnet tool install --global dotnet-counters</code></p>
<p>Then view the list of available counters using <code>dotnet-counters list</code>.  At the time of writing there are two sets, <code>System.Runtime</code> and <code>Microsoft.AspNetCore.Hosting</code> although it is possible to also monitor user defined counters.</p>
<p>``` powershell
System.Runtime
    cpu-usage                                    Amount of time the process has utilized the CPU (ms)
    working-set                                  Amount of working set used by the process (MB)
    gc-heap-size                                 Total heap size reported by the GC (MB)
    gen-0-gc-count                               Number of Gen 0 GCs / sec
    gen-1-gc-count                               Number of Gen 1 GCs / sec
    gen-2-gc-count                               Number of Gen 2 GCs / sec
    time-in-gc                                   % time in GC since the last GC
    gen-0-size                                   Gen 0 Heap Size
    gen-1-size                                   Gen 1 Heap Size
    gen-2-size                                   Gen 2 Heap Size
    loh-size                                     LOH Heap Size
    alloc-rate                                   Allocation Rate
    assembly-count                               Number of Assemblies Loaded
    exception-count                              Number of Exceptions / sec
    threadpool-thread-count                      Number of ThreadPool Threads
    monitor-lock-contention-count                Monitor Lock Contention Count
    threadpool-queue-length                      ThreadPool Work Items Queue Length
    threadpool-completed-items-count             ThreadPool Completed Work Items Count
    active-timer-count                           Active Timers Count</p>
<p>Microsoft.AspNetCore.Hosting
    requests-per-second                  Request rate
    total-requests                       Total number of requests
    current-requests                     Current number of requests
    failed-requests                      Failed number of requests
```</p>
<p>Start your application running than find it's PID,  either using <code>ps</code>,  TaskManager or easier still <code>dotnet-counters ps</code></p>
<p><code>powershell
    12345   MyApplication c:\software\MyApplication.exe</code></p>
<h2>Real-Time Monitoring</h2>
<p>The <code>dotnet-counters monitor</code> command can be used to view the counters as they change in real time.  It should be started with <code>-p</code> followed by your application's PID and then a space separated list of counters to monitor.   (The documentation says that all counters are included by default, but I found that only the <code>System.Runtime</code> ones are.)</p>
<p>This example shows all counters</p>
<p><code>powershell
dotnet-counters monitor -p 12345 System.Runtime Microsoft.AspNetCore.Hosting</code></p>
<p>``` powershell
Press p to pause, r to resume, q to quit.
    Status: Running</p>
<p>[System.Runtime]
    # of Assemblies Loaded                           179
    % Time in GC (since last GC)                       0
    Allocation Rate (Bytes / sec)                204,200
    CPU Usage (%)                                      0
    Exceptions / sec                                   0
    GC Heap Size (MB)                                 23
    Gen 0 GC / sec                                     0
    Gen 0 Size (B)                             9,415,056
    Gen 1 GC / sec                                     0
    Gen 1 Size (B)                                   856
    Gen 2 GC / sec                                     0
    Gen 2 Size (B)                             9,156,440
    LOH Size (B)                              10,809,624
    Monitor Lock Contention Count / sec                0
    Number of Active Timers                           10
    ThreadPool Completed Work Items / sec              1
    ThreadPool Queue Length                            0
    ThreadPool Threads Count                           4
    Working Set (MB)                                 147
    ...
```</p>
<p>Individual counters can be monitored by listing them within square brackets.  For example</p>
<p><code>powershell
dotnet-counters monitor -p 28764 Microsoft.AspNetCore.Hosting[requests-per-second,failed-requests]</code></p>
<p>``` powershell
Press p to pause, r to resume, q to quit.
    Status: Running</p>
<p>[Microsoft.AspNetCore.Hosting]
    Failed Requests                                    0
    Request / sec                                      0
```</p>
<p>An optional <code>--refreshInterval</code> argument controls (in seconds) how often the counters are refreshed.</p>
<h2>Collection</h2>
<p>In addition to monitoring the counters in real time it is possible periodically collect them and write them to a file using <code>dotnet-counters collect</code></p>
<p>This takes the same <code>-p</code>,  <code>--refreshInterval</code> and list of counters as the <code>monitor</code> command,  but also takes two additional arguments <code>--format</code> and <code>--output</code></p>
<ul>
<li><code>--format</code> is the type of file to create,  either <code>csv</code> (default) or <code>json</code>.</li>
<li><code>--output</code> is an optional argument to specify the name of the file to create.  By default this is <code>counter.csv</code> / <code>counter.json</code> and will be created in the current folder.</li>
</ul>
<p>It looks like this file will get pretty big quickly,  so choose the counters to collect and refresh interval wisely!</p>
<h2>Troubleshooting</h2>
<p>If no counters are being collected then</p>
<ol>
<li>
<p>Using <code>dotnet-counters ps</code> double check the PID of your process.</p>
</li>
<li>
<p>Make sure that the list of counter sets is correct.  These are space separated (not comma separated).  e.g <code>System.Runtime Microsoft.AspNetCore.Hosting</code> not <code>System.Runtime, Microsoft.AspNetCore.Hosting</code></p>
</li>
<li>
<p>If you are specifying individual counters,  then make sure that these are commas separated without any spaces. e.g  <code>Microsoft.AspNetCore.Hosting[requests-per-second,failed-requests]</code> not <code>Microsoft.AspNetCore.Hosting[requests-per-second, failed-requests]</code></p>
</li>
</ol>
<h2>References</h2>
<p>Microsoft documentation - https://docs.microsoft.com/en-us/dotnet/core/diagnostics/dotnet-counters</p>
<p>NDC Talk (Hidden gems in .NET Core 3 - David Fowler &amp; Damian Edwards) - https://www.youtube.com/watch?v=xdSSH63IZZc</p>
            </div>
        </div>
    </div>
    <script type='text/javascript' src='/theme.js'></script>

</body>

</html>